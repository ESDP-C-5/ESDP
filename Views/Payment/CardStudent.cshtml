@model CRM.Models.Student


<div class="row">
    <div class="col-sm-4 border border-dark">
        <dt class="col-sm-2">
            ФИО Ребенка
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.LastName)
            @Html.DisplayFor(model => model.Name)
            @Html.DisplayFor(model => model.FatherName)
        </dd>
        <dt class="col-sm-2">
            Номер телефона
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.PhoneNumber)
        </dd>
        <dt class="col-sm-2">
            Дата последней оплаты
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Payments.LastOrDefault().DateTimePayment)
        </dd>
        <dt class="col-sm-2">
            Стоимость
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.StudentPaymentAndPeriods.LastOrDefault().MustTotal)
        </dd>
        <dt class="col-sm-2">
            Сумма за все периоды
        </dt>
        <dd class="col-sm-10">
            @{
                decimal summ = 0;
                foreach (var period in Model.StudentPaymentAndPeriods)
                {
                    summ += period.MustTotal;
                }
            }
            @summ
        </dd>
        <dt class="col-sm-2">
            Фактическая cумма за все периоды
        </dt>
        <dd class="col-sm-10">
            @{
                decimal AllTotal = 0;
                foreach (var payment in Model.Payments)
                {
                    AllTotal += payment.Total;
                }
            }
            @AllTotal
        </dd>
        <dt class="col-sm-2">
            Задолжность
        </dt>
        <dd class="col-sm-10">
            @{ decimal raz = summ - AllTotal; }
            @raz
        </dd>

    </div>
    <div class="col-8">
        <div class="row border border-dark">
            <div class="col-2">Период</div>
            <div class="col-2">Сумма опл:</div>
            <div class="col-2">Факт опл:</div>
            <div class="col-2">Дата опл:</div>
            <div class="col-2">Примечание</div>
            <div class="col-2">Оплата</div>
        </div>
          @foreach (var item in Model.StudentPaymentAndPeriods)
          {
              <div class="row border border-dark">
                  <div class="col-2">
                        @Html.DisplayFor(modelItem => item.PaymentPeriodStart)
                        @Html.DisplayFor(modelItem => item.PaymentPeriodEnd)
                    </div>
                  <div class="col-2">
                      @Html.DisplayFor(modelItem => item.MustTotal)
                  </div>
                  <div class="col-6 row">
                      
                      @foreach (var payment in item.Payments)
                      {
                          <div class="col-4">
                              @Html.DisplayFor(modelItem => payment.Total)
                          </div>
                          <div class="col-4">
                              @Html.DisplayFor(modelItem => payment.DateTimePayment)
                          </div>
                          <div class="col-4">
                              @Html.DisplayFor(modelItem => payment.Comment)
                          </div>
                      }
                  </div>
                  <div class="col-2">
                      @{
                          decimal debt = 0;

                          foreach (var payment in item.Payments)
                          {
                              debt += payment.Total;
                          }
                          decimal placeholder = item.MustTotal - debt;
                          if (item.MustTotal > debt)
                          {
                              <input type="number" style="width: 7em" id="dept" placeholder="@placeholder" required>
                              <input type="text"size="7em" id="comment" placeholder="Коментарии" required>
                              <button onclick="AddPayment(@item.Id,@item.StudentId)">Добавить оплату</button>
                          }

                      }
                  </div>
              </div>      
          }
        </div>
            <div>
                Дата начало
                <input type="date" id="dateStart" value="@DateTime.Now">
                <input type="dateEnd" id="dateEnd" value="@DateTime.Now">
                <input type="number" id="mustTotal" required>
                <button onclick="AddPeriod(@Model.Id)">Добавить период</button>
            </div>
        </div>
@section Scripts {
    <script >
         function AddPayment(periodId,studentId) {
             var dept = $('#dept').val();
             var text = $('#comment').val();
                $.ajax({
                    url: '@Url.Action("AddPayment", "Payment")',
                    type: 'POST',
                    data: { 'periodID': periodId, 'studentId': studentId,'payment':dept,'text': text },
                    success: function (data) {
                     },
                });
             }
    </script><script >
         function AddPeriod(StudentId) {
             var dateStart = $('#dateStart').val();
             var mustTotal = $('#mustTotal').val();
             var dateEnd = $('#dateEnd').val();
                $.ajax({
                    url: '@Url.Action("AddPeriod", "Payment")',
                    type: 'POST',
                    data: { 'dateStart': dateStart, 'mustTotal': mustTotal,'StudentId':StudentId,'dateEnd':dateEnd },
                    success: function (data) {
                        
                     },
                });
             }
    </script>
}